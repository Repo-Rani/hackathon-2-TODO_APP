name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: Run tests
      run: |
        # Add your test commands here
        echo "Running tests..."
        # pytest or other test commands

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend

    - name: Build and push backend
      uses: docker/build-push-action@v4
      with:
        context: .
        file: backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend

    - name: Build and push frontend
      uses: docker/build-push-action@v4
      with:
        context: .
        file: frontend/Dockerfile
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Setup Dapr
      run: |
        wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash
        dapr status -k

    - name: Install Oracle Cloud CLI (OCI CLI)
      run: |
        curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh -o install.sh
        chmod +x install.sh
        ./install.sh --accept-all-defaults --non-interactive
        oci --version

    - name: Configure OCI CLI
      run: |
        mkdir -p ~/.oci
        echo "[DEFAULT]" > ~/.oci/config
        echo "user=${{ secrets.OCI_USER }}" >> ~/.oci/config
        echo "key_file=~/.oci/oci_api_key.pem" >> ~/.oci/config
        echo "fingerprint=${{ secrets.OCI_KEY_FINGERPRINT }}" >> ~/.oci/config
        echo "tenancy=${{ secrets.OCI_TENANCY }}" >> ~/.oci/config
        echo "region=${{ secrets.OCI_REGION }}" >> ~/.oci/config

        # Save the API key
        echo "${{ secrets.OCI_API_KEY }}" > ~/.oci/oci_api_key.pem
        chmod 600 ~/.oci/oci_api_key.pem

    - name: Get OKE cluster credentials
      run: |
        oci ce cluster create-kubeconfig --cluster-id ${{ secrets.OCI_CLUSTER_ID }} --file $HOME/.kube/config --region ${{ secrets.OCI_REGION }} --token-version 2.0.0

    - name: Update Helm values with image tags
      run: |
        # Update the values file with the built image tags
        sed -i "s|repository: todo-backend|repository: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend|g" helm-charts/todo-app-phase-v/values.yaml
        sed -i "s|tag: \"\"|tag: ${{ github.sha }}|g" helm-charts/todo-app-phase-v/values.yaml
        sed -i "s|repository: todo-frontend|repository: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend|g" helm-charts/todo-app-phase-v/values.yaml

    - name: Deploy using Helm
      run: |
        # Add the Bitnami repository for Kafka and PostgreSQL
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo update

        # Install/upgrade the application
        helm upgrade --install todo-app ./helm-charts/todo-app-phase-v \
          --namespace todo-app --create-namespace \
          --values helm-charts/todo-app-phase-v/values.yaml \
          --timeout 10m

    - name: Verify deployment
      run: |
        kubectl wait --for=condition=ready pod -l app=backend -n todo-app --timeout=300s
        kubectl wait --for=condition=ready pod -l app=frontend -n todo-app --timeout=300s
        kubectl get pods -n todo-app
        kubectl get services -n todo-app

    - name: Run deployment tests
      run: |
        # Add end-to-end tests here if needed
        echo "Verifying deployment..."
        kubectl get pods -n todo-app
        kubectl get services -n todo-app